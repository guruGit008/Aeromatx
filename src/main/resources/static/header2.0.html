<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroMatX | RF Components</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .search-bar {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 20px;
            flex-grow: 1;
            width: 600px;
        }

        .search-bar input {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 300%;
            font-size: 16px;
        }

        .search-bar button {
            background-color: #007bff;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        .search-bar button i {
            font-size: 14px;
        }

        /* Profile and User Display Styles */
        .profile-icon {
            display: flex;
            align-items: center;
            margin-left: 10px;
            color: #333;
            text-decoration: none;
        }

        .profile-icon i {
            font-size: 20px;
            margin-right: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #user-display {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-login {
            background-color: #007bff;
            color: white;
        }

        .btn-register {
            background-color: #28a745;
            color: white;
        }

        .btn-logout {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
        }

        /* Debug info */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Debug info panel -->
    <!-- <div class="debug-info" id="debug-info">
        <strong>Debug Info:</strong><br>
        <span id="debug-content">Loading...</span>
    </div> -->

    <header class="header">
        <div class="top-bar">
            <span class="highlight">
                Empowering Breakthrough Innovations â€” Seamlessly From Raw Materials to RF Excellence !
            </span>
        </div>
        <nav class="main-nav">
            <div class="nav-container">
                <a href="index.html" class="logo">
                    <span class="aero">Aero</span>
                    <span class="matx">MatX</span>
                </a>

                <ul class="nav-menu" id="navMenu">
                    <li class="nav-item">
                        <a href="index.html" class="nav-link dropdown">All Categories</a>
                        <div class="mega-menu">
                        </div>
                    </li>
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search products..." />
                        <button type="button" onclick="searchProducts()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </ul>

                <div class="nav-actions">
                    <div class="cart-wishlist">
                        <a href="#cart" class="cart-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="badge">0</span>
                        </a>
                    </div>

                    <div class="auth-buttons" id="auth-buttons-container">
                        <!-- Login/Register buttons (shown when logged out) -->
                        <a href="login.html" class="btn btn-login" id="login-button">Login</a>
                        <a href="register.html" class="btn btn-register" id="register-button">Register</a>
                        
                        <!-- User info (shown when logged in) -->
                        <div class="user-info" id="user-info" style="display: none;">
                            <a href="profile.html" class="profile-icon" id="profile-icon-link">
                                <i class="fas fa-user-circle"></i>
                            </a>
                            <span id="user-display"></span>
                            <button class="btn btn-logout" id="logout-button">Logout</button>
                        </div>
                    </div>

                    <button class="mobile-toggle" id="mobileToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </nav>
        <link href="../static/css/style.css" rel="stylesheet">
    </header>

    <script>
        // Debug function
        function updateDebugInfo(message) {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                debugContent.innerHTML = message;
            }
            console.log('DEBUG:', message);
        }

        // Mobile menu functionality
        (function() {
            const mobileToggle = document.getElementById('mobileToggle');
            const navMenu = document.getElementById('navMenu');

            if (mobileToggle && navMenu) {
                mobileToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                    const icon = this.querySelector('i');

                    if (navMenu.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            }
        })();

        // Search functionality
        function searchProducts() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const query = searchInput.value.toLowerCase();
                if (query) {
                    window.location.href = `search.html?q=${encodeURIComponent(query)}`;
                }
            }
        }

        // Authentication functionality
        document.addEventListener("DOMContentLoaded", function() {
            const authToken = localStorage.getItem("authToken");
            const userDisplay = document.getElementById("user-display");
            const loginButton = document.getElementById("login-button");
            const registerButton = document.getElementById("register-button");
            const logoutButton = document.getElementById("logout-button");
            const authButtonsContainer = document.getElementById("auth-buttons-container");
            const userInfo = document.getElementById("user-info");

            // Debug localStorage contents
            updateDebugInfo(`Token: ${authToken ? 'EXISTS' : 'MISSING'}<br>Stored Username: ${localStorage.getItem("loggedInUsername") || 'NONE'}`);

            function showLoggedOutState() {
                console.log("Showing logged out state");
                updateDebugInfo("State: LOGGED OUT");
                if (userInfo) userInfo.style.display = "none";
                if (loginButton) loginButton.style.display = "inline-block";
                if (registerButton) registerButton.style.display = "inline-block";
                if (authButtonsContainer) authButtonsContainer.classList.remove("logged-in");
            }

            function showLoggedInState(username) {
                console.log("Showing logged in state for:", username);
                updateDebugInfo(`State: LOGGED IN<br>Username: ${username}`);
                if (userDisplay) userDisplay.textContent = `Hello, ${username}`;
                if (userInfo) userInfo.style.display = "flex";
                if (loginButton) loginButton.style.display = "none";
                if (registerButton) registerButton.style.display = "none";
                if (authButtonsContainer) authButtonsContainer.classList.add("logged-in");
            }

            // Check authentication status
            if (authToken) {
                console.log("Auth token found:", authToken.substring(0, 20) + "...");
                updateDebugInfo(`Token found: ${authToken.substring(0, 20)}...<br>Fetching user info...`);
                
                // Try to get username from localStorage first
                const storedUsername = localStorage.getItem("loggedInUsername");
                if (storedUsername) {
                    console.log("Found stored username:", storedUsername);
                    showLoggedInState(storedUsername);
                }

                // Verify with server - CHANGE THIS URL TO MATCH YOUR SERVER
                const serverUrl = "http://localhost:8080"; // Change this to your actual server URL
                
                fetch(`${serverUrl}/api/users/me`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${authToken}`,
                        "Content-Type": "application/json"
                    }
                })
                .then(response => {
                    console.log("Server response status:", response.status);
                    updateDebugInfo(`Server response: ${response.status}<br>Status: ${response.ok ? 'OK' : 'ERROR'}`);
                    
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                })
                .then(userData => {
                    console.log("User data received:", userData);
                    updateDebugInfo(`User data received:<br>Username: ${userData.username || 'NOT FOUND'}`);
                    
                    if (userData && userData.username) {
                        localStorage.setItem("loggedInUsername", userData.username);
                        showLoggedInState(userData.username);
                    } else {
                        console.error("Username not found in response data");
                        updateDebugInfo("ERROR: Username not found in response");
                        localStorage.removeItem("loggedInUsername");
                        localStorage.removeItem("authToken");
                        showLoggedOutState();
                    }
                })
                .catch(error => {
                    console.error("Error fetching user info:", error);
                    updateDebugInfo(`ERROR: ${error.message}`);
                    
                    // Don't immediately clear tokens - might be a network issue
                    // Only clear if it's an auth error
                    if (error.message.includes('401') || error.message.includes('403')) {
                        localStorage.removeItem("loggedInUsername");
                        localStorage.removeItem("authToken");
                        showLoggedOutState();
                    } else {
                        // Network error - show stored username if available
                        const storedUsername = localStorage.getItem("loggedInUsername");
                        if (storedUsername) {
                            showLoggedInState(storedUsername);
                        } else {
                            showLoggedOutState();
                        }
                    }
                });
            } else {
                console.log("No auth token found in localStorage.");
                updateDebugInfo("No auth token found");
                showLoggedOutState();
            }

            // Logout functionality
            if (logoutButton) {
                logoutButton.addEventListener("click", function(event) {
                    event.preventDefault();
                    console.log("Logging out...");
                    updateDebugInfo("Logging out...");
                    localStorage.removeItem("loggedInUsername");
                    localStorage.removeItem("authToken");
                    showLoggedOutState();
                    
                    // Small delay before redirect to show the state change
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 500);
                });
            }

            // Hide debug info after 10 seconds (optional)
            setTimeout(() => {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.style.opacity = '0.3';
                }
            }, 10000);
        });
    </script>
</body>
</html>